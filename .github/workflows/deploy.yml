name: ğŸš€ Auto Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: ğŸ” é…ç½®SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: ğŸš€ éƒ¨ç½²åˆ°æœåŠ¡å™¨
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd ${{ secrets.PROJECT_PATH }}
            
            # è¾“å‡ºå½“å‰çŠ¶æ€
            echo "ğŸ“‚ å½“å‰ç›®å½•: $(pwd)"
            echo "ğŸ” å½“å‰åˆ†æ”¯: $(git branch --show-current)"
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            git fetch origin
            git reset --hard origin/main
            
            # æ˜¾ç¤ºæœ€æ–°æäº¤
            echo "âœ… æœ€æ–°æäº¤:"
            git log -1 --oneline
            
            # é‡å¯DockeræœåŠ¡
            echo "ğŸ³ é‡å¯Dockerå®¹å™¨..."
            ./start.sh stop
            ./start.sh start --build
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 10
            
            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            echo "ğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
            docker ps
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          ENDSSH
      
      - name: âœ… éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "æœåŠ¡å™¨: ${{ secrets.SERVER_HOST }}"
          echo "é¡¹ç›®: ${{ secrets.PROJECT_PATH }}"
      
      - name: âŒ éƒ¨ç½²å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
