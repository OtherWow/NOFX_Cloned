name: ğŸš€ Build & Deploy to Server

on:
  push:
    branches:
      - main

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    name: æ„å»ºå¹¶æ¨é€Dockeré•œåƒ
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: ğŸ” ç™»å½•GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ“ æå–Dockerå…ƒæ•°æ®
        id: meta-backend
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend
          tags: |
            type=raw,value=latest
            type=sha,prefix={{branch}}-
      
      - name: ğŸ“ æå–å‰ç«¯Dockerå…ƒæ•°æ®
        id: meta-frontend
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend
          tags: |
            type=raw,value=latest
            type=sha,prefix={{branch}}-
      
      - name: ğŸ”¨ æ„å»ºå¹¶æ¨é€åç«¯é•œåƒ
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./docker/Dockerfile.backend
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
      
      - name: ï¿½ æ„å»ºå¹¶æ¨é€å‰ç«¯é•œåƒ
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./docker/Dockerfile.frontend
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}

  deploy:
    name: éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: ï¿½ é…ç½®SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: ğŸš€ éƒ¨ç½²åˆ°æœåŠ¡å™¨
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            # è¿›å…¥éƒ¨ç½²ç›®å½•
            cd ${{ secrets.PROJECT_PATH }}
            
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°é•œåƒ..."
            docker pull ghcr.io/otherwow/nofx_cloned/backend:latest
            docker pull ghcr.io/otherwow/nofx_cloned/frontend:latest
            
            echo "ğŸ›‘ åœæ­¢æ—§å®¹å™¨..."
            docker compose -f docker-compose.prod.yml down || true
            
            echo "ğŸš€ å¯åŠ¨æ–°å®¹å™¨..."
            docker compose -f docker-compose.prod.yml up -d
            
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 10
            
            echo "ğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
            docker ps
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          ENDSSH
      
      - name: âœ… éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "åç«¯é•œåƒ: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend:latest"
          echo "å‰ç«¯é•œåƒ: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:latest"
      
      - name: âŒ éƒ¨ç½²å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
